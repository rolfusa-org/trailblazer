# Main Branch Flow Analysis - ROLF Trailblazer

**Repository**: rolfusa-org/trailblazer  
**Purpose**: Understanding the main branch workflow and configuration

---

## Question 1: What Happens When Main Branch Gets Pushed to GitHub?

### Trigger

```yaml
on:
  push:
    branches: [ main ]  # ← Only pushes to main branch trigger the workflow
  workflow_dispatch:      # ← Can also be triggered manually from GitHub UI
```

**Answer**: When you push to the `main` branch, it automatically triggers the GitHub Actions workflow.

### Complete Flow

```
Push to main branch
        ↓
GitHub Actions Workflow Starts
        ↓
┌───────────────────────────────────────────────────┐
│ Step 1: Checkout and Setup                        │
│ - Clone repository (depth 50)                     │
│ - Configure git identity                          │
│ - Uses native git commands (no external actions)  │
└───────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────┐
│ Step 2: Install Dependencies                      │
│ - Install: jq, tree, rsync                        │
│ - jq: JSON parsing in bash                        │
│ - tree: Directory visualization                   │
│ - rsync: Efficient file copying                   │
└───────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────┐
│ Step 3: Parse Config and Checkout Versions        │
│ - Read flavors-config.json                        │
│ - For each feature (feature-a, feature-b, etc):   │
│   - For each version in feature.versions:         │
│     - Clone specific tag (e.g., feature-a-v0.2.0) │
│     - Store in checkout_{feature}_{version}/      │
│ - Handles missing tags gracefully (continues)     │
└───────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────┐
│ Step 4: Generate Version Metadata                 │
│ - For each checked-out version:                   │
│   - Extract git commit hash (short)               │
│   - Calculate build number (commit count)         │
│   - Create version.json using jq with:            │
│     * version, date, commit, buildNumber          │
│     * flavor name, tag name                       │
└───────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────┐
│ Step 5: Build Deployment Structure                │
│ - Create deploy/ directory                        │
│ - Copy from main branch:                          │
│   - index.html (landing page/feature selector)    │
│   - flavors-config.json                           │
│   - shared/ (flavor-switcher.js, .css)           │
│ - For each version:                               │
│   - Copy to deploy/{deployPath}/                  │
│   - Example: checkout_feature-a_0.2.0/ →          │
│              deploy/feature-a/v0.2.0/             │
│ - Uses rsync to exclude .git directories          │
└───────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────┐
│ Step 6: Deploy to GitHub Pages                    │
│ - Initialize git in deploy/ directory             │
│ - Create gh-pages branch (orphan)                 │
│ - Add all files                                   │
│ - Commit with message: "deploy: update from       │
│   main @ {commit-sha}"                            │
│ - Force push to gh-pages branch using             │
│   native git commands and GITHUB_TOKEN            │
└───────────────────────────────────────────────────┘
        ↓
GitHub Pages Updates (1-2 minutes)
        ↓
Site Live at: https://rolfusa-org.github.io/trailblazer/
```

### What Gets Deployed

**Final gh-pages structure**:
```
/
├── index.html              ← From main branch (landing page)
├── flavors-config.json     ← From main branch (config)
├── shared/                 ← From main branch (shared UI components)
│   ├── flavor-switcher.js  ← Version/feature switcher logic
│   └── flavor-switcher.css ← Switcher styling
│
├── feature-a/              ← Feature A namespace
│   ├── v0.2.0/            ← From tag feature-a-v0.2.0 (Latest)
│   │   ├── index.html
│   │   ├── script.js
│   │   ├── styles.css
│   │   ├── version.json   ← Auto-generated by workflow
│   │   └── CHANGELOG.md
│   └── v0.1.0/            ← From tag v0.1.0 (Stable)
│       └── (same files)
│
├── feature-b/              ← Feature B namespace
│   ├── v0.2.0/            ← From tag feature-b-v0.2.0
│   └── v0.1.0/            ← From tag v0.1.0
│
└── feature-c/              ← Feature C namespace
    ├── v0.2.0/            ← From tag feature-c-v0.2.0
    └── v0.1.0/            ← From tag v0.1.0
```

### Key Points

1. **Only main branch triggers deployment** - Feature branches (`feature-a`, `feature-b`, `feature-c`) don't trigger anything
2. **Config-driven** - `flavors-config.json` in main branch controls everything
3. **Tag-based** - Each version references a specific Git tag (branch-specific naming)
4. **Native Git commands** - Uses only built-in Git (no external GitHub Actions due to repo restrictions)
5. **Force push** - gh-pages is completely replaced each time (no history kept)
6. **Atomic** - All-or-nothing deployment
7. **Nested paths** - Each version deploys to `{feature}/{version}/`

---

## Question 2: Is There a Setting in Config to Specify the Default Branch and Version GitHub Pages Points To?

### Answer: YES - The `flavors-config.json` Controls Everything

### How It Works

The **`flavors-config.json`** file in the **main branch** is the single source of truth that controls:
1. Which features are visible on the landing page
2. Which versions are deployed for each feature
3. Which version is the default for each feature
4. Where each version is deployed (URL path)
5. Feature status (active, beta, development, coming-soon)

### Configuration Breakdown

```json
{
  "version": "1.0",
  "lastUpdated": "2025-10-23",
  "project": {
    "name": "ROLF Trailblazer",
    "description": "Exploration with safety and privacy in mind",
    "repository": "https://github.com/rolfusa-org/trailblazer"
  },
  "flavors": [
    {
      "key": "feature-a",                     // Unique identifier
      "name": "Feature A",                    // Display name
      "shortName": "Feature A",               // Abbreviated name
      "icon": "fa-rocket",                    // FontAwesome icon
      "description": "Baseline implementation for exploration features.",
      "branch": "feature-a",                  // ← Source branch (reference only)
      "status": "active",                     // ← Status type (active/beta/dev)
      "visible": true,                        // ← Show on landing page?
      
      "versions": [                           // ← THIS CONTROLS DEPLOYMENT
        {
          "version": "0.2.0",                 // Display version
          "tag": "feature-a-v0.2.0",          // ← Git tag to checkout
          "label": "Latest",                  // UI label
          "isDefault": true,                  // ← Default version for this feature
          "deployPath": "feature-a/v0.2.0",   // ← Where to deploy on gh-pages
          "releaseDate": "2025-10-23"         // Release date
        },
        {
          "version": "0.1.0",
          "tag": "v0.1.0",
          "label": "Stable",
          "isDefault": false,                 // Not the default
          "deployPath": "feature-a/v0.1.0",
          "releaseDate": "2025-10-23"
        }
      ]
    },
    {
      "key": "feature-b",
      "name": "Feature B",
      "branch": "feature-b",
      "status": "beta",                       // Shows "Beta" badge
      "visible": true,
      "versions": [
        // ... same structure
      ]
    },
    {
      "key": "feature-c",
      "name": "Feature C",
      "branch": "feature-c",
      "status": "development",                // Shows "In Development"
      "visible": true,
      "versions": [
        // ... same structure
      ]
    }
  ],
  "statusTypes": {                            // Status badge definitions
    "active": {
      "label": "Live",
      "color": "#48bb78",                     // Green
      "clickable": true
    },
    "beta": {
      "label": "Beta",
      "color": "#ed8936",                     // Orange
      "clickable": true
    },
    "development": {
      "label": "In Development",
      "color": "#cbd5e0",                     // Gray
      "clickable": true
    },
    "coming-soon": {
      "label": "Coming Soon",
      "color": "#cbd5e0",                     // Gray
      "clickable": false                      // Can't click/open
    }
  }
}
```

### Configuration Options Explained

#### 1. **Control Which Features Are Visible**

```json
{
  "visible": true,    // Show on landing page
  "visible": false    // Hide from landing page (but still accessible via direct URL)
}
```

**Use case**: Hide experimental features until ready

#### 2. **Control Which Versions Are Deployed**

**Only versions listed in the `versions` array get deployed.**

```json
"versions": [
  {
    "version": "0.3.0",
    "tag": "feature-a-v0.3.0",  // ← Workflow checks out this tag
    "isDefault": true,           // This opens by default
    "deployPath": "feature-a/v0.3.0"
  },
  {
    "version": "0.2.0",
    "tag": "feature-a-v0.2.0",
    "isDefault": false,          // Available but not default
    "deployPath": "feature-a/v0.2.0"
  }
  // v0.1.0 not listed → won't be deployed (saves space)
]
```

#### 3. **Control Which Version Is Default**

**When user clicks a feature on landing page, it opens the version with `isDefault: true`.**

```json
{
  "isDefault": true   // ← This version opens by default
}
```

**Important**: Only ONE version per feature should have `isDefault: true`.

**Landing page behavior**:
```javascript
// In index.html
const defaultVersion = flavor.versions.find(v => v.isDefault);
if (defaultVersion) {
  window.location.href = defaultVersion.deployPath + '/';
}
```

#### 4. **Control Deployment Path**

```json
{
  "deployPath": "feature-a/v0.2.0"  // ← Deploys to /feature-a/v0.2.0/ on GitHub Pages
}
```

**URL will be**: `https://rolfusa-org.github.io/trailblazer/feature-a/v0.2.0/`

**Nested structure benefits**:
- Clear organization by feature
- Version comparison easier (same base path)
- Shared components accessible via relative path `../../shared/`

#### 5. **Control Feature Status**

```json
{
  "status": "active",        // Shows "Live" badge (green, clickable)
  "status": "beta",          // Shows "Beta" badge (orange, clickable)
  "status": "development",   // Shows "In Development" (gray, clickable)
  "status": "coming-soon"    // Shows "Coming Soon" (gray, NOT clickable)
}
```

**Effect on UI**:
- Badge color and text defined in `statusTypes`
- If `clickable: false`, card is disabled on landing page

### What the Workflow Does With Config

```bash
# Step 1: Read config
CONFIG_FILE="flavors-config.json"
FLAVOR_COUNT=$(jq '.flavors | length' $CONFIG_FILE)

# Step 2: Loop through each feature
for ((i=0; i<$FLAVOR_COUNT; i++)); do
  FLAVOR_KEY=$(jq -r ".flavors[$i].key" $CONFIG_FILE)
  VERSION_COUNT=$(jq ".flavors[$i].versions | length" $CONFIG_FILE)
  
  # Step 3: Loop through each version
  for ((j=0; j<$VERSION_COUNT; j++)); do
    TAG=$(jq -r ".flavors[$i].versions[$j].tag" $CONFIG_FILE)
    DEPLOY_PATH=$(jq -r ".flavors[$i].versions[$j].deployPath" $CONFIG_FILE)
    
    # Step 4: Clone the tag
    git clone --depth 1 --branch $TAG $REPO checkout_dir
    
    # Step 5: Generate version.json
    jq -n \
      --arg version "$VERSION" \
      --arg date "$RELEASE_DATE" \
      --arg commit "$COMMIT" \
      --argjson buildNumber "$BUILD_NUM" \
      --arg flavor "$FLAVOR_NAME" \
      --arg tag "$TAG" \
      '{version: $version, date: $date, commit: $commit, buildNumber: $buildNumber, flavor: $flavor, tag: $tag}' \
      > checkout_dir/version.json
    
    # Step 6: Copy to deployment path
    rsync -av --exclude='.git' checkout_dir/ deploy/$DEPLOY_PATH/
  done
done
```

---

## Practical Examples

### Example 1: Add a New Version of Feature A

**Scenario**: You've tagged `feature-a-v0.3.0` on `feature-a` branch and want to deploy it.

**Step 1**: Create and push the tag (on feature-a branch)
```bash
git checkout feature-a
# Make changes, commit them
git tag feature-a-v0.3.0
git push origin feature-a
git push origin feature-a-v0.3.0
```

**Step 2**: Update `flavors-config.json` on main branch
```json
{
  "key": "feature-a",
  "versions": [
    {
      "version": "0.3.0",
      "tag": "feature-a-v0.3.0",      // ← New tag
      "label": "Latest",
      "isDefault": true,               // ← Make this the default
      "deployPath": "feature-a/v0.3.0",
      "releaseDate": "2025-10-24"
    },
    {
      "version": "0.2.0",
      "tag": "feature-a-v0.2.0",
      "label": "Stable",
      "isDefault": false,              // ← Old default becomes false
      "deployPath": "feature-a/v0.2.0",
      "releaseDate": "2025-10-23"
    },
    {
      "version": "0.1.0",
      "tag": "v0.1.0",
      "label": "Legacy",
      "isDefault": false,
      "deployPath": "feature-a/v0.1.0",
      "releaseDate": "2025-10-23"
    }
  ]
}
```

**Step 3**: Commit and push main branch
```bash
git checkout main
git add flavors-config.json
git commit -m "deploy: publish Feature A v0.3.0"
git push origin main    # ← This triggers the workflow
```

**Result**: 
- Workflow deploys all 3 versions (v0.3.0, v0.2.0, v0.1.0)
- Landing page shows v0.3.0 as default for Feature A
- Users can switch between versions via version switcher

### Example 2: Retire an Old Version

**Scenario**: Remove v0.1.0 to save space, keep only v0.3.0 and v0.2.0

**Update config**:
```json
{
  "key": "feature-a",
  "versions": [
    {
      "version": "0.3.0",
      "tag": "feature-a-v0.3.0",
      "label": "Latest",
      "isDefault": true,
      "deployPath": "feature-a/v0.3.0",
      "releaseDate": "2025-10-24"
    },
    {
      "version": "0.2.0",
      "tag": "feature-a-v0.2.0",
      "label": "Stable",
      "isDefault": false,
      "deployPath": "feature-a/v0.2.0",
      "releaseDate": "2025-10-23"
    }
    // v0.1.0 removed - won't be deployed
  ]
}
```

**Commit and push**:
```bash
git checkout main
git commit -am "deploy: retire Feature A v0.1.0"
git push origin main    # ← Redeploys without v0.1.0
```

**Result**: v0.1.0 removed from gh-pages, only v0.3.0 and v0.2.0 remain

**Note**: The tag `v0.1.0` still exists in Git for rollback if needed

### Example 3: Hide a Feature (Coming Soon Status)

**Scenario**: Feature D is in early development, show it as "Coming Soon"

**Update config**:
```json
{
  "key": "feature-d",
  "name": "Feature D",
  "branch": "feature-d",
  "status": "coming-soon",      // ← "Coming Soon" status
  "visible": true,               // Show on landing page
  "versions": []                 // ← No versions deployed yet
}
```

**Result**: 
- Feature D card appears on landing page
- Shows "Coming Soon" badge (gray)
- Card is NOT clickable (disabled)
- No deployment space used

### Example 4: Change Default Version Without Redeploying

**Scenario**: Feature B v0.2.0 has issues, switch default back to v0.1.0

**Update config**:
```json
{
  "key": "feature-b",
  "versions": [
    {
      "version": "0.2.0",
      "tag": "feature-b-v0.2.0",
      "label": "Latest",
      "isDefault": false,           // ← No longer default
      "deployPath": "feature-b/v0.2.0",
      "releaseDate": "2025-10-23"
    },
    {
      "version": "0.1.0",
      "tag": "v0.1.0",
      "label": "Stable",
      "isDefault": true,            // ← Now the default
      "deployPath": "feature-b/v0.1.0",
      "releaseDate": "2025-10-23"
    }
  ]
}
```

**Commit and push**:
```bash
git checkout main
git commit -am "deploy: rollback Feature B default to v0.1.0"
git push origin main
```

**Result**: 
- Both versions still deployed (no changes to files)
- Landing page now opens v0.1.0 by default
- Users can still access v0.2.0 via version switcher

### Example 5: Deploy Different Versions for Each Feature

**Scenario**: Features evolve at different paces

**Current state**:
```json
{
  "flavors": [
    {
      "key": "feature-a",
      "status": "active",
      "versions": [
        { "version": "0.3.0", "tag": "feature-a-v0.3.0", "isDefault": true },
        { "version": "0.2.0", "tag": "feature-a-v0.2.0", "isDefault": false }
      ]
    },
    {
      "key": "feature-b",
      "status": "beta",
      "versions": [
        { "version": "0.2.0", "tag": "feature-b-v0.2.0", "isDefault": true }
      ]
    },
    {
      "key": "feature-c",
      "status": "development",
      "versions": [
        { "version": "0.1.0", "tag": "v0.1.0", "isDefault": true }
      ]
    }
  ]
}
```

**Result**: 
- Feature A: 2 versions (most mature)
- Feature B: 1 version (in beta testing)
- Feature C: 1 version (early development)
- Each can progress independently

---

## GitHub Pages Settings

### Where GitHub Pages Points

**GitHub Repository Settings** → **Pages**:
- **Source**: Deploy from a branch
- **Branch**: `gh-pages` (root)

**This setting tells GitHub which branch to serve**, but:
- You never manually edit `gh-pages` branch
- Workflow automatically force-pushes to `gh-pages`
- `gh-pages` content is controlled by `main` branch config

### GitHub Pages URL Structure

**Base URL**: `https://rolfusa-org.github.io/trailblazer/`

**Landing page**: `https://rolfusa-org.github.io/trailblazer/` (root index.html)

**Feature versions**:
- Feature A v0.2.0: `https://rolfusa-org.github.io/trailblazer/feature-a/v0.2.0/`
- Feature B v0.2.0: `https://rolfusa-org.github.io/trailblazer/feature-b/v0.2.0/`
- Feature C v0.1.0: `https://rolfusa-org.github.io/trailblazer/feature-c/v0.1.0/`

**Path matches `deployPath` in config**:
```json
{
  "deployPath": "feature-a/v0.2.0"  // ← Becomes /feature-a/v0.2.0/ on GitHub Pages
}
```

---

## Key Differences from togethering-demo

### 1. **Branch-Specific Tags**
- **Trailblazer**: Uses `feature-a-v0.2.0`, `feature-b-v0.2.0` (branch-specific)
- **Togethering**: Uses `v1.0.0` (can reuse across flavors if they start together)

**Why**: Git tags are global, so different features need unique tag names.

### 2. **Feature Naming**
- **Trailblazer**: `feature-a`, `feature-b`, `feature-c` (abstract features)
- **Togethering**: `html`, `pwa`, `nextjs` (technology-specific)

**Why**: Trailblazer focuses on feature variants, not tech stack differences.

### 3. **Branding**
- **Trailblazer**: ROLF green theme (#10b981), compass logo
- **Togethering**: Purple theme, togethering branding

### 4. **Native Git Workflow**
- **Trailblazer**: Uses only native Git commands (due to repo restrictions)
- **Togethering**: Could use external actions if desired

---

## Key Takeaways

### 1. **Main Branch is the Control Center**
- Push to main → Triggers deployment
- Never push to feature branches expecting deployment
- Config in main controls everything

### 2. **flavors-config.json is the Single Source of Truth**
- Controls which versions are deployed
- Controls which version is default
- Controls visibility and status
- Controls deployment paths

### 3. **Branch-Specific Tags for Independent Versions**
- Each feature uses unique tag names (e.g., `feature-a-v0.2.0`)
- Allows features to evolve at their own pace
- Prevents tag conflicts

### 4. **Storage Efficient**
- Only deploy versions you list in config
- Can have 100 tags in Git, but deploy only selected ones
- Remove versions by updating config (tags remain for history)

### 5. **Atomic Deployments**
- Entire site updates at once
- No partial deployments
- Force-push ensures clean state

### 6. **Nested Path Structure**
- Each version at `{feature}/{version}/`
- Clear organization
- Shared components at `../../shared/`

---

## Workflow Sequence Diagram

```
┌──────────────┐
│  Developer   │
└──────┬───────┘
       │
       │ 1. Tag feature branch with branch-specific name
       ├──────────────────────────────┐
       │                              │
       │                        ┌─────▼──────┐
       │                        │ feature-a  │
       │                        │ (branch)   │
       │                        └─────┬──────┘
       │                              │
       │                              │ Tag: feature-a-v0.3.0
       │                              │
       │ 2. Update config on main     │
       ├──────────────────┐           │
       │                  │           │
       │            ┌─────▼──────────────────────┐
       │            │ main branch                │
       │            │ flavors-config.json        │
       │            │ {                          │
       │            │   "tag": "feature-a-v0.3.0"│◄──┘
       │            │   "isDefault": true        │
       │            │   "deployPath": "..."      │
       │            │ }                          │
       │            └─────┬──────────────────────┘
       │                  │
       │ 3. Push main     │
       └──────────────────┤
                          │
                    ┌─────▼──────────┐
                    │ GitHub Actions │
                    │ Workflow       │
                    │ (Native Git)   │
                    └─────┬──────────┘
                          │
                          │ Reads config
                          │ Checkouts tags
                          │ Generates version.json
                          │ Builds nested structure
                          │
                    ┌─────▼──────────┐
                    │ gh-pages       │
                    │ branch         │
                    └─────┬──────────┘
                          │
                          │ Force push
                          │
                    ┌─────▼──────────┐
                    │ GitHub Pages   │
                    │ (Live Site)    │
                    └────────────────┘
```

---

## Summary

### Question 1: What happens when main branch gets pushed?

**Answer**: 
1. GitHub Actions workflow triggers (only for pushes to `main`)
2. Reads `flavors-config.json`
3. Checks out all tags specified in config (branch-specific tags)
4. Generates `version.json` for each version using `jq`
5. Builds nested deployment structure: `{feature}/{version}/`
6. Copies landing page, config, and shared components
7. Force-pushes to `gh-pages` branch using native Git commands
8. GitHub Pages serves the updated site (~5-10 minutes total)

### Question 2: Is there a config setting for default branch/version?

**Answer**: 
**YES - `flavors-config.json` controls everything:**

**Default Feature**: Landing page shows all `visible: true` features, user selects one.

**Default Version per Feature**: Set `isDefault: true` on the version you want to open by default:
```json
{
  "versions": [
    {
      "version": "0.2.0",
      "tag": "feature-a-v0.2.0",
      "isDefault": true,          // ← Opens by default
      "deployPath": "feature-a/v0.2.0"
    }
  ]
}
```

**Full Control**:
- ✅ Which features are visible (`visible`)
- ✅ Which versions deploy (`versions[]` array)
- ✅ Default version (`isDefault`)
- ✅ Deployment paths (`deployPath`)
- ✅ Feature status badges (`status`)

**Key insight**: You control the entire deployment—what's visible, what's deployed, what's default—by editing one file (`flavors-config.json`) in the main branch.

---

**Last Updated**: 2025-10-26  
**Applies to**: rolfusa-org/trailblazer repository

